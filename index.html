<html>


<head>
	<title>MAD MINUTES</title>
	<link href="https://fonts.googleapis.com/css?family=Faster+One" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
	<link href="madminutes.css" rel="stylesheet">
	<script src="madminutes.js"></script>
	<script src="config.js"></script>
	<script src="utils.js"></script>

	<script src="debug.js"></script>
</head>


<script>
	const typeSetData = CONFIG.data;
	var timeoutA = null;
	var timeoutB = null;

	var countDownTimeout = null;

	var currentTime = null;

	var selectedType = null;
	var selectedSet = null;
	var selectedProblemData = null;  // randomized problems can go here. 
	var selectedMaxPass = null;
	var selectedMaxTime = null;
	var numberCorrect = 0;

	function setup() {
		// var el = document.getElementById('foo');
		// el.innerHTML = 'Hello World!';


		// displayMainPage();
		// displayProblemSetPage(MM.CONST.TYPE.MUL, "K");
		displayProblemSetPage(MM.CONST.TYPE.DIV, "C");

		fillInAnswers();
	}

	document.addEventListener('keydown', function (e) {
		var leftArrowKey = 37;
		var rightArrowKey = 39;
		var upArrowKey = 38;
		var dnArrowKey = 40;
		var delKey = 8;
		var enterKey = 13;
		var spaceKey = 32;
		// console.log('keydown:' + e.keyCode);

		var el = e.target;
		var id = el.id;

		if (e.keyCode == delKey) {
			e.preventDefault();
			el.value = "";
			return false;
		}

		if (e.keyCode == enterKey) {
			e.preventDefault();
			checkForCompletion(focusOnNextInput(id));
			return false;
		}

		if (e.keyCode == spaceKey) {
			e.preventDefault();
			checkForCompletion(focusOnNextInput(id));
			return false;
		}

		// if key is an arrow key, don't type the user
		// input. 
		if (e.keyCode > 36 && e.keyCode < 41) {
			e.preventDefault();

			if (e.keyCode == rightArrowKey || e.keyCode == upArrowKey)
				checkForCompletion(focusOnNextInput(id));
			if (e.keyCode == leftArrowKey || e.keyCode == dnArrowKey)
				checkForCompletion(focusOnPrevInput(id));

			return false;
		}

	});


	// was going to make if the user clicks anywhere with the mouse
	// focus will be automatically placed in the last empty input 
	document.addEventListener('click', function (event) {
		// if(!$(event.target).closest('#menucontainer').length) {
		//     if($('#menucontainer').is(":visible")) {
		//         $('#menucontainer').hide();
		//     }
		// }        
		// console.log("clicky clicky");
	});





	function displayMainPage() {
		clearTimeouts();
		changeToColorLogo();
		hideCloseButton();
		hideMessage();
		hideScoreSheet();

		const html = MM.htmlForTypeSetData(typeSetData);
		htmlToMain(html);
	}

	function htmlToDiv(id, html) {
		var el = document.getElementById(id);
		el.innerHTML = html;
	}
	function htmlToMain(html) { htmlToDiv("mathContent", html); }

	function displayReadySetGo() {
		outputReadySetGoMessage("Ready", "redLight");
		timeoutA = setTimeout(function () { outputReadySetGoMessage("Set", "yellowLight") }, 1500);
		timeoutB = setTimeout(function () {
			outputReadySetGoMessage("Go", "greenLight");
			var el = document.getElementById('mathContent');
			el.classList.remove("blur");


			startCountDown();
		}, 3000);

		// calculateScore();
	}



	// from https://codepen.io/ishanbakshi/pen/pgzNMv
	function startCountDown() {
		// var presentTime = document.getElementById('countDown').innerHTML;
		var timeArray = currentTime.split(/[:]+/);
		var m = timeArray[0];
		var s = checkSecond((timeArray[1] - 1));
		if (s == 59) { m = m - 1 }

		if (m < 0) {
			console.log('timer completed')
			calculateScore();
			return;
		}


		var lcta = selectedMaxTime.split(/[:]+/);
		var m_last = lcta[0];
		var s_last = lcta[1];
		var lastCurrentSetTimeTotalSeconds = parseInt(m_last) * 60 + parseInt(s_last);
		var currentTimeTotalSeconds = parseInt(m) * 60 + parseInt(s);
		var percentageComplete = currentTimeTotalSeconds / lastCurrentSetTimeTotalSeconds;

		var maxClip = 48; // pixels
		var startFaster = 0; // start 12 pixels in

		var progress = maxClip * (1 - percentageComplete) + startFaster;
		progress = Math.ceil(progress);

		var svgID = document.getElementById('zachSVG');
		svgID.style.clipPath = "circle(" + progress + "px at 0 0px)";

		// document.getElementById('countDown').innerHTML = m + ":" + s;
		currentTime = m + ":" + s;
		// console.log( percentageComplete + " -- " + progress + " -- " + m + ":" + s);

		countDownTimeout = setTimeout(startCountDown, 1000);
	}

	function checkSecond(sec) {
		if (sec < 10 && sec >= 0) { sec = "0" + sec }; // add zero in front of numbers < 10
		if (sec < 0) { sec = "59" };
		return sec;
	}

	function clearTimeouts() {
		if (timeoutA)
			clearTimeout(timeoutA);
		if (timeoutB)
			clearTimeout(timeoutB);
		if (countDownTimeout)
			clearTimeout(countDownTimeout);
	}

	function calculateScore() {
		clearTimeouts();

		console.log("Calculating score.");
		var el = document.getElementById('scoreSheet');
		el.classList.add("scoreSheetSlide");

		numberCorrect = 0; // reset this

		checkNumberCorrect(selectedType);

		displayScoring();

		// pass , try again
		// # total 
		// # correct
		// # wrong
		// accuracy
		// spark charts?? 
		// 
		// fix the # wrong and you get... something... +1 second next time for every corrected up to 5
		// fix it all and you get statistics. 
		//  
		// previous high scores tally per set


		// save set score for last 5 per set.
		// save set score for top 5 per set (most completed problems)
		// when accomplished. 
		// 
	}


	function setupMaxVarsForSet(set) {
		var match = set.match(/50/);
		if (match) {
			selectedMaxTime = CONFIG.maxTime50;
			currentTime = selectedMaxTime;
			selectedMaxPass = CONFIG.maxPass50;
		}
		else {
			selectedMaxTime = CONFIG.maxTime;
			currentTime = selectedMaxTime;
			selectedMaxPass = CONFIG.maxPass;
		}
	}

	function checkNumberCorrect(type) {
		selectedProblemData.forEach(function (prob, i) {
			// go through each problem and check the input answer with calculated one
			// if it's wrong, then highlight the wrong answer in red. 

			var firstNum = prob[0];
			var secNum = prob[1];
			var calculatedAnswer = null;

			switch (type) {
				case "Multiplication":
					calculatedAnswer = firstNum * secNum;
					break;
				case "Division":
					calculatedAnswer = firstNum / secNum;
					break;
				default:
			}


			// console.log(firstNum + " " + secNum + " = " + calculatedAnswer );

			var answerInputID = document.getElementById("answer_" + i);
			if (answerInputID.value != "") {

				// if any input changes on wrong problems, then we can change the class to correct
				answerInputID.addEventListener('input', function (evt) {
					// console.log(this);

					var studentAnswer = this.value

					var idx = getIdxFromInputID(this.id);
					var prob = selectedProblemData[idx];
					var firstNum = prob[0];
					var secNum = prob[1];

					if (calculatedAnswer == studentAnswer) {
						answerInputID.classList.remove("checkAnswer");
						answerInputID.classList.add("correctedAnswer");
					}
				});

				var studentAnswer = parseFloat(answerInputID.value);
				if (calculatedAnswer != studentAnswer) {
					answerInputID.classList.add("checkAnswer");
				}
				else {
					numberCorrect++;
				}
			}
		});
	}


	function displayScoring() {
		var scoreMessageArray = tryAgainMessages;

		var numCorrectID = document.getElementById("numCorrect");
		numCorrectID.innerHTML = "+" + numberCorrect;

		if (numberCorrect >= selectedMaxPass) {
			var passCheckID = document.getElementById("passCheck");
			passCheckID.style.display = "block";

			scoreMessageArray = passedMessages;
		} else {
			var passCheckID = document.getElementById("passCheck");
			passCheckID.style.display = "none";
		}


		var randomInt = MM.getRandomInt(scoreMessageArray.length);
		var message = scoreMessageArray[randomInt];
		var scoreMessageID = document.getElementById("scoreMessage");
		scoreMessageID.innerHTML = message;

		var scoreSheetID = document.getElementById("scoreSheet");
		scoreSheetID.style.display = "block";
	}

	function outputReadySetGoMessage(message, cssClass) {
		var el = document.getElementById('message');
		el.innerHTML = "";

		var html = "<div id='readySetGoWrapper' class='lightSpeedOut animated " + cssClass + "'><div id='readySetGoMessage'>" + message + "</div></div>";

		el.innerHTML = html;
	}

	function setSetLabel(label) {
		var el = document.getElementById('setLabel');
		el.innerHTML = label;
	}



	function checkForCompletion(cb) {
		// if all inputs have been filled, then score the answers
		// otherwise run the cb
		const className = "answers";
		const probs = document.getElementsByClassName(className);

		let inputsFilledCorrectly = true;
		iterateCollection(probs)((p, i) => {
			if (isNumeric(p.value) == false)
				inputsFilledCorrectly = false
		});

		if (inputsFilledCorrectly) 
			calculateScore();
		else
			cb
	}

	function focusOnFirstProblem() {
		var firstProb = document.getElementById("answer_0");
		firstProb.focus();
	}

	function focusOnNextInput(id) {
		var idx = getIdxFromInputID(id);
		var incremented = parseInt(idx) + 1;

		var nextEL = document.getElementById("answer_" + incremented);
		nextEL.focus();
	}

	function focusOnPrevInput(id) {
		var idx = getIdxFromInputID(id);
		var decremented = parseInt(idx) - 1;

		var nextEL = document.getElementById("answer_" + decremented);
		nextEL.focus();
	}

	function getIdxFromInputID(id) {
		var re = /answer_(\d+)/;
		var results = id.match(re);

		var idx = results[1];
		return idx;
	}

	function blurMain() {
		var el = document.getElementById('mathContent');
		el.innerHTML = "";
		el.classList.add("blur");

	}

	function displayProblemSetPage(type, set) {
		changeToBlackWhiteLogo();
		showCloseButton();
		showMessage();
		// blurMain();

		selectedType = type;
		selectedSet = set;

		const problemSet = MM.getProblemSetForTypeAndSet(typeSetData, type, set);
		const html = MM.htmlForTypeProblemSet(type, problemSet);
		htmlToMain(html);

		setSetLabel(set);
		setupMaxVarsForSet(set);
		displayReadySetGo();
		focusOnFirstProblem();
	}

	function setupProblemsForTypeAndSet(type, set) {
		const problemSet = getProblemSetForTypeAndSet(typeSetData, type, set);
		const html = htmlForProblemSet(problemSet);


		outputProblems(type, problems);
		setSetLabel(set);
		setupMaxVarsForSet(set);
		displayReadySetGo();
	}

	function changeToBlackWhiteLogo() {
		var logo = document.getElementById('logo');
		var logoSecond = document.getElementById('logoSecond');
		var zachSVG = document.getElementById('zachSVG');

		logoSecond.classList.remove("logoLighter");
		logoSecond.classList.add("logoDark");
		logoSecond.classList.add("logoDarkLighter");

		logo.classList.remove("logo");
		logo.classList.add("logoDark");

		zachSVG.classList.add("zachSVGBW")
		zachSVG.style.clipPath = "unset";
	}

	function changeToColorLogo() {
		var logo = document.getElementById('logo');
		var logoSecond = document.getElementById('logoSecond');
		var zachSVG = document.getElementById('zachSVG');

		logoSecond.classList.remove("logoDark");
		logoSecond.classList.remove("logoDarkLighter");
		logoSecond.classList.add("logoLighter");

		logo.classList.remove("logoDark");
		logo.classList.add("logoColor");

		zachSVG.classList.remove("zachSVGBW")

		zachSVG.style.clipPath = "unset";

	}

	function showCloseButton() {
		var el = document.getElementById('home');
		el.style.display = 'block';
	}

	function hideCloseButton() {
		var el = document.getElementById('home');
		el.style.display = 'none';
	}

	function showMessage() {
		var el = document.getElementById('message');
		el.style.display = 'block';
	}

	function hideMessage() {
		var el = document.getElementById('message');
		el.style.display = 'none';
	}

	function hideScoreSheet() {
		var scoreSheetID = document.getElementById("scoreSheet");
		scoreSheetID.style.display = "none";
	}


</script>


<body onLoad="setup();">

	<div id="scoreSheet">
		<div id="scoreContent">
			<a href="#" onClick="displayMainPage();">
				<span>Back</span>
			</a>

			<div id="scoreMessage">
			</div>

			<div id="score">
				<div id="numCorrect"></div>
				<div id="passCheck" onClick="displayMainPage();">
					<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
						<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
						<path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
					</svg>
				</div>
			</div>
		</div>
	</div>


	<div id="wrapper">
		<div id="banner">
			<!-- <div id="logo">MM</div> -->
			<div id="logo" onClick="displayMainPage();">MAD
				<span id="logoSecond" class="logoLighter">MINUTES</span>
				<img id="zachSVG" src="zach-dinosaur.svg"></img>
			</div>


			<div id="message"></div>
			<!-- <div id="countDown">0:01</div> -->


			<div id="home" onClick="displayMainPage();">
				<div id="setTitle">
					<span class="weakerFont">Set </span>
					<span id="setLabel">A</span>
				</div>
				<div class="close-button"></div>
				<!-- <div class="clearer"></div> -->
			</div>


			<div class="clearer"></div>
		</div>
		<div id="mathContent"></div>

	</div>
</body>


</html>